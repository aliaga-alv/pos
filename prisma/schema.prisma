generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  name              String
  role              UserRole           @default(WAITER)
  active            Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orders            Order[]
  stockTransactions StockTransaction[]
}

enum UserRole {
  ADMIN
  WAITER
  KITCHEN
  CASHIER
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Category {
  id        String    @id @default(uuid())
  name      String
  order     Int       @default(0)
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  products  Product[]
}

model Product {
  id          String              @id @default(uuid())
  name        String
  description String?
  price       Decimal             @db.Decimal(10, 2)
  categoryId  String
  category    Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  imageUrl    String?
  available   Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  orderItems  OrderItem[]
  ingredients ProductIngredient[]

  @@index([categoryId])
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model Ingredient {
  id               String              @id @default(uuid())
  name             String
  unit             UnitType            @default(PIECE)
  currentStock     Decimal             @db.Decimal(10, 3)
  minStock         Decimal             @db.Decimal(10, 3) @default(0)
  maxStock         Decimal?            @db.Decimal(10, 3)
  costPerUnit      Decimal             @db.Decimal(10, 2)
  supplier         String?
  active           Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  products         ProductIngredient[]
  stockTransactions StockTransaction[]

  @@index([active])
}

enum UnitType {
  KILOGRAM
  GRAM
  LITER
  MILLILITER
  PIECE
  DOZEN
  PACK
  CUP
  TABLESPOON
  TEASPOON
}

model ProductIngredient {
  id           String     @id @default(uuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  quantity     Decimal    @db.Decimal(10, 3)
  createdAt    DateTime   @default(now())

  @@unique([productId, ingredientId])
  @@index([productId])
  @@index([ingredientId])
}

model StockTransaction {
  id           String              @id @default(uuid())
  ingredientId String
  ingredient   Ingredient          @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  type         TransactionType
  quantity     Decimal             @db.Decimal(10, 3)
  notes        String?
  reference    String?
  userId       String?
  user         User?               @relation(fields: [userId], references: [id])
  createdAt    DateTime            @default(now())

  @@index([ingredientId])
  @@index([type])
  @@index([createdAt])
}

enum TransactionType {
  PURCHASE
  USAGE
  WASTE
  ADJUSTMENT
  RETURN
}

// ============================================
// TABLE MANAGEMENT
// ============================================

model Table {
  id        String      @id @default(uuid())
  number    Int         @unique
  seats     Int         @default(4)
  status    TableStatus @default(AVAILABLE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  orders    Order[]
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
}

// ============================================
// ORDER MANAGEMENT
// ============================================

model Order {
  id           String      @id @default(uuid())
  orderNumber  Int         @unique @default(autoincrement())
  type         OrderType
  tableId      String?
  table        Table?      @relation(fields: [tableId], references: [id])
  customerName String?
  status       OrderStatus @default(PENDING)
  items        OrderItem[]
  subtotal     Decimal     @db.Decimal(10, 2)
  tax          Decimal     @db.Decimal(10, 2) @default(0)
  total        Decimal     @db.Decimal(10, 2)
  notes        String?
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  payment      Payment?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([tableId])
}

enum OrderType {
  COUNTER
  TABLE
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  notes     String?

  @@index([orderId])
  @@index([productId])
}

// ============================================
// PAYMENT
// ============================================

model Payment {
  id      String        @id @default(uuid())
  orderId String        @unique
  order   Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount  Decimal       @db.Decimal(10, 2)
  method  PaymentMethod
  paidAt  DateTime      @default(now())
}

enum PaymentMethod {
  CASH
  CARD
  OTHER
}
